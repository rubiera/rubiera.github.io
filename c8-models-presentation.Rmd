---
title: "Machine Learning Modeling of Selected Weight-lifting Activites"
author: "Antonio Rubiera"
date: "11/21/2019"
output: html_document
---

```{r models-setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Summary of this Analysis

In this analysis, we evaluate the data used by Velloso et al. in their paper "Qualitative Activity Recognition of Weight Lifting Exercises" [ACM SIGCHI 2013]. The data was collected for six young men performing weight-lifting exercises with a light dumbbell (1.25 KG) using five pre-determined sequences (named as the variable 'classe' in the dataset). Sequence A is the correct sequence, and sequences B, C, D, and E are variations of the men performing the weigth-lifting exercise incorrectly. Sequences B, C, D, and E are specific ways to perform the weigth-lifting exercise incorrectly, and this means that the four wrong sequences should be just as separable from each other as they are from A.

We use a specific seed (22) to ensure our data runs are reproducible. We perform exploratory data analysis (EDA), caret model selection, and feature selection in an appendix. The steps relegated to an appendix are as follows:

- Explore the unaggregated training time series data to get a feel for what movements were performed for each sequence, as captured by the classe variable. We plot a small sample of these.

- Explore the aggregated training time series data after selecting only the rows containing these fileds, and removing fields that contain no data, all zeroes and/or all NA values.

```{r model-library-seed, warning=FALSE, message=FALSE}
library(tidyverse)
library(caret)
library(knitr)
library(plotly)
set.seed(22)
```

## Time Series (Not Aggregated over Time) Data

The training dataset has two types of data: a time series dataset, and time window measurements of this time series data. Here is the time series data. The measurements in this data for sensors located at the belt, arm (glove), forearm, and dumbbell are:

- The Euler angles (roll, pitch, yaw)
- Gyroscope measurement (x,y,z)
- Magnetometer measurement (x,y,z)
- Acceleration measurement (x,y,z)

```{r data-time, warning=FALSE, message=FALSE}
training_all <- read.csv("./data/pml-training.csv")
training_all_data <- select(training_all, c("user_name",
                            "raw_timestamp_part_1","raw_timestamp_part_2",
                            "cvtd_timestamp","new_window","num_window","roll_belt",
                            "pitch_belt","yaw_belt","total_accel_belt","gyros_belt_x",
                            "gyros_belt_y","gyros_belt_z","accel_belt_x","accel_belt_y",
                            "accel_belt_z","magnet_belt_x","magnet_belt_y",
                            "magnet_belt_z","roll_arm","pitch_arm","yaw_arm",
                            "total_accel_arm","gyros_arm_x","gyros_arm_y",
                            "gyros_arm_z","accel_arm_x","accel_arm_y","accel_arm_z",
                            "magnet_arm_x","magnet_arm_y","magnet_arm_z","roll_dumbbell",
                            "pitch_dumbbell","yaw_dumbbell","total_accel_dumbbell",
                            "gyros_dumbbell_x","gyros_dumbbell_y","gyros_dumbbell_z",
                            "accel_dumbbell_x","accel_dumbbell_y","accel_dumbbell_z",                                                    "magnet_dumbbell_x","magnet_dumbbell_y","magnet_dumbbell_z",
                            "roll_forearm","pitch_forearm","yaw_forearm",
                            "total_accel_forearm","gyros_forearm_x",
                            "gyros_forearm_y","gyros_forearm_z","accel_forearm_x",
                            "accel_forearm_y","accel_forearm_z","magnet_forearm_x",
                            "magnet_forearm_y","magnet_forearm_z","classe"))
```

Here are the counts by user_name and classe for the time series data.

```{r data-kable-1, warning=FALSE, message=FALSE}
kable(table(training_all_data$user_name, training_all_data$classe))
```

## Time Series Exploratory Data Analysis

We zero the time distributions by user_name and by classe. Because each of the thirty time series were collected at different times, each one has to be time-zeroed individually. As an example, we compare the A sequence for two user_names for the roll of the belt measurement.

```{r EDA-1, warning=FALSE, message=FALSE}
trg_data <- mutate(training_all_data, rel_time = as.numeric(paste(raw_timestamp_part_1,
                                raw_timestamp_part_2,sep=".")))

trg_adelmo_A <- filter(trg_data,user_name == "adelmo" & classe == "A")
trg_adelmo_B <- filter(trg_data,user_name == "adelmo" & classe == "B")
trg_adelmo_C <- filter(trg_data,user_name == "adelmo" & classe == "C")
trg_adelmo_D <- filter(trg_data,user_name == "adelmo" & classe == "D")
trg_adelmo_E <- filter(trg_data,user_name == "adelmo" & classe == "E")

trg_data_adelmo_A_left <- mutate(trg_adelmo_A, time_left = rel_time - min(rel_time))
trg_data_adelmo_B_left <- mutate(trg_adelmo_B, time_left = rel_time - min(rel_time))
trg_data_adelmo_C_left <- mutate(trg_adelmo_C, time_left = rel_time - min(rel_time))
trg_data_adelmo_D_left <- mutate(trg_adelmo_D, time_left = rel_time - min(rel_time))
trg_data_adelmo_E_left <- mutate(trg_adelmo_E, time_left = rel_time - min(rel_time))

trg_carlitos_A <- filter(trg_data,user_name == "carlitos" & classe == "A")
trg_carlitos_B <- filter(trg_data,user_name == "carlitos" & classe == "B")
trg_carlitos_C <- filter(trg_data,user_name == "carlitos" & classe == "C")
trg_carlitos_D <- filter(trg_data,user_name == "carlitos" & classe == "D")
trg_carlitos_E <- filter(trg_data,user_name == "carlitos" & classe == "E")

trg_data_carlitos_A_left <- mutate(trg_carlitos_A, time_left = rel_time - min(rel_time))
trg_data_carlitos_B_left <- mutate(trg_carlitos_B, time_left = rel_time - min(rel_time))
trg_data_carlitos_C_left <- mutate(trg_carlitos_C, time_left = rel_time - min(rel_time))
trg_data_carlitos_D_left <- mutate(trg_carlitos_D, time_left = rel_time - min(rel_time))
trg_data_carlitos_E_left <- mutate(trg_carlitos_E, time_left = rel_time - min(rel_time))

trg_charles_A <- filter(trg_data,user_name == "charles" & classe == "A")
trg_charles_B <- filter(trg_data,user_name == "charles" & classe == "B")
trg_charles_C <- filter(trg_data,user_name == "charles" & classe == "C")
trg_charles_D <- filter(trg_data,user_name == "charles" & classe == "D")
trg_charles_E <- filter(trg_data,user_name == "charles" & classe == "E")

trg_data_charles_A_left <- mutate(trg_charles_A, time_left = rel_time - min(rel_time))
trg_data_charles_B_left <- mutate(trg_charles_B, time_left = rel_time - min(rel_time))
trg_data_charles_C_left <- mutate(trg_charles_C, time_left = rel_time - min(rel_time))
trg_data_charles_D_left <- mutate(trg_charles_D, time_left = rel_time - min(rel_time))
trg_data_charles_E_left <- mutate(trg_charles_E, time_left = rel_time - min(rel_time))

trg_eurico_A <- filter(trg_data,user_name == "eurico" & classe == "A")
trg_eurico_B <- filter(trg_data,user_name == "eurico" & classe == "B")
trg_eurico_C <- filter(trg_data,user_name == "eurico" & classe == "C")
trg_eurico_D <- filter(trg_data,user_name == "eurico" & classe == "D")
trg_eurico_E <- filter(trg_data,user_name == "eurico" & classe == "E")

trg_data_eurico_A_left <- mutate(trg_eurico_A, time_left = rel_time - min(rel_time))
trg_data_eurico_B_left <- mutate(trg_eurico_B, time_left = rel_time - min(rel_time))
trg_data_eurico_C_left <- mutate(trg_eurico_C, time_left = rel_time - min(rel_time))
trg_data_eurico_D_left <- mutate(trg_eurico_D, time_left = rel_time - min(rel_time))
trg_data_eurico_E_left <- mutate(trg_eurico_E, time_left = rel_time - min(rel_time))

trg_jeremy_A <- filter(trg_data,user_name == "jeremy" & classe == "A")
trg_jeremy_B <- filter(trg_data,user_name == "jeremy" & classe == "B")
trg_jeremy_C <- filter(trg_data,user_name == "jeremy" & classe == "C")
trg_jeremy_D <- filter(trg_data,user_name == "jeremy" & classe == "D")
trg_jeremy_E <- filter(trg_data,user_name == "jeremy" & classe == "E")

trg_data_jeremy_A_left <- mutate(trg_jeremy_A, time_left = rel_time - min(rel_time))
trg_data_jeremy_B_left <- mutate(trg_jeremy_B, time_left = rel_time - min(rel_time))
trg_data_jeremy_C_left <- mutate(trg_jeremy_C, time_left = rel_time - min(rel_time))
trg_data_jeremy_D_left <- mutate(trg_jeremy_D, time_left = rel_time - min(rel_time))
trg_data_jeremy_E_left <- mutate(trg_jeremy_E, time_left = rel_time - min(rel_time))

trg_pedro_A <- filter(trg_data,user_name == "pedro" & classe == "A")
trg_pedro_B <- filter(trg_data,user_name == "pedro" & classe == "B")
trg_pedro_C <- filter(trg_data,user_name == "pedro" & classe == "C")
trg_pedro_D <- filter(trg_data,user_name == "pedro" & classe == "D")
trg_pedro_E <- filter(trg_data,user_name == "pedro" & classe == "E")

trg_data_pedro_A_left <- mutate(trg_pedro_A, time_left = rel_time - min(rel_time))
trg_data_pedro_B_left <- mutate(trg_pedro_B, time_left = rel_time - min(rel_time))
trg_data_pedro_C_left <- mutate(trg_pedro_C, time_left = rel_time - min(rel_time))
trg_data_pedro_D_left <- mutate(trg_pedro_D, time_left = rel_time - min(rel_time))
trg_data_pedro_E_left <- mutate(trg_pedro_E, time_left = rel_time - min(rel_time))

plot_ly(x = sort(trg_data_adelmo_A_left$time_left),
        y = trg_data_adelmo_A_left$roll_belt,
        mode = 'lines', 
        text = "Belt Roll for Adelmo, A sequence (seconds), Belt Roll (degrees) ")
plot_ly(x = sort(trg_data_carlitos_A_left$time_left),
        y = trg_data_carlitos_A_left$roll_belt,
        mode = 'lines', 
        text = "Belt Roll for Carlitos, A sequence (seconds), Belt Roll (degrees) ")
plot_ly(x = sort(trg_data_adelmo_E_left$time_left),
        y = trg_data_adelmo_E_left$roll_belt,
        mode = 'lines', 
        text = "Belt Roll for Adelmo, E sequence (seconds), Belt Roll (degrees) ")
plot_ly(x = sort(trg_data_carlitos_E_left$time_left),
        y = trg_data_carlitos_E_left$roll_belt,
        mode = 'lines', 
        text = "Belt Roll for Carlitos, E sequence (seconds), Belt Roll (degrees) ")

```

Aggregated Time Bin Data

The time bin data calculates measures from the time bin data in time windows. The Euler angles for sensors located at the belt, arm (glove), forearm, and dumbbell as magnitude quantities for the x,y,z measurements in the time series data are:

- Kurtosis and Skewness.
- Minimum, Maximum, and Average.
- Amplitude.
- Variance and Standard Deviation.

Here are the time window measurements after removal of several columns that only contained zeros or NAs:

- kurtosis_yaw_belt
- skewness_yaw_belt
- kurtosis_yaw_dumbbell
- skewness_yaw_dumbbell
- kurtosis_yaw_forearm
- skewness_yaw_forearm
- amplitude_yaw_dumbbell
- amplitude_yaw_forearm
- amplitude_yaw_belt

```{r data-sdvar, warning=FALSE, message=FALSE}
training_all_clean <- read.csv("./data/pml-training.csv",
                               na.strings = c("NA","NaN","","#DIV/0!"))
training_nonblanks_clean <- filter(training_all_clean, kurtosis_roll_belt != "")
training_nonblanks_clean <- mutate(training_nonblanks_clean, 
                   rel_time = as.numeric(paste(raw_timestamp_part_1,
                   raw_timestamp_part_2,sep=".")))
training_sdvar_sel_clean_all <- select(training_nonblanks_clean,c("user_name",
        "classe","raw_timestamp_part_1","raw_timestamp_part_2","cvtd_timestamp",
        "new_window","num_window","kurtosis_roll_belt","kurtosis_picth_belt",
        "skewness_roll_belt",
        "skewness_roll_belt.1","max_roll_belt","max_picth_belt",
        "max_yaw_belt","min_roll_belt","min_pitch_belt","min_yaw_belt","amplitude_roll_belt",
        "amplitude_pitch_belt","var_total_accel_belt","avg_roll_belt",
        "stddev_roll_belt","var_roll_belt","avg_pitch_belt","stddev_pitch_belt","var_pitch_belt",
        "avg_yaw_belt","stddev_yaw_belt","var_yaw_belt","var_accel_arm","avg_roll_arm",
        "stddev_roll_arm","var_roll_arm","avg_pitch_arm","stddev_pitch_arm","var_pitch_arm",
        "avg_yaw_arm","stddev_yaw_arm","var_yaw_arm","kurtosis_roll_arm","kurtosis_picth_arm",
        "kurtosis_yaw_arm","skewness_roll_arm","skewness_pitch_arm","skewness_yaw_arm",
        "max_roll_arm","max_picth_arm","max_yaw_arm","min_roll_arm","min_pitch_arm",
        "min_yaw_arm","amplitude_roll_arm","amplitude_pitch_arm","amplitude_yaw_arm",
        "kurtosis_roll_dumbbell","kurtosis_picth_dumbbell",
        "skewness_roll_dumbbell","skewness_pitch_dumbbell",
        "max_roll_dumbbell","max_picth_dumbbell","max_yaw_dumbbell","min_roll_dumbbell",
        "min_pitch_dumbbell","min_yaw_dumbbell","amplitude_roll_dumbbell","amplitude_pitch_dumbbell",
        "total_accel_dumbbell","var_accel_dumbbell","avg_roll_dumbbell",
        "stddev_roll_dumbbell","var_roll_dumbbell","avg_pitch_dumbbell","stddev_pitch_dumbbell",
        "var_pitch_dumbbell","avg_yaw_dumbbell","stddev_yaw_dumbbell","var_yaw_dumbbell",
        "kurtosis_roll_forearm","kurtosis_picth_forearm",
        "skewness_roll_forearm","skewness_pitch_forearm",
        "max_roll_forearm","max_picth_forearm","max_yaw_forearm","min_roll_forearm",
        "min_pitch_forearm","min_yaw_forearm","amplitude_roll_forearm","amplitude_pitch_forearm",
        "total_accel_forearm","var_accel_forearm","avg_roll_forearm",
        "stddev_roll_forearm","var_roll_forearm","avg_pitch_forearm","stddev_pitch_forearm",
        "var_pitch_forearm","avg_yaw_forearm","stddev_yaw_forearm","var_yaw_forearm",
        "rel_time"))
```

Here are the counts by user_name and classe for the time bin data.

```{r data-kable-2, warning=FALSE, message=FALSE}
kable(table(training_sdvar_sel_clean_all$user_name, training_sdvar_sel_clean_all$classe))
```

## Time Bin Exploratory Data Analysis

The relevance of using machine learning for data with many variables is evident when we plot selected variables for the time bin series. There are too many combinations of scatter plots for us to plot and we do not need to. What we need to do is use the functions at our disposal to find the level of correlation between the variables in our data, and subtract those with too high a correlation. We are getting ahead of ourselves with the plots showing below because we will later determine the level of correlation for the variables in our training data, yet it's worth using that advance knowlegde here to stress the point that the need for a machine learning analysis becomes evident when there is a very large number of correlations that can be calculated from the variables in our data.

```{r EDA-2, warning=FALSE, message=FALSE}
training_sdvar_sel_clean_all_A <- filter(training_sdvar_sel_clean_all, classe == "A")
training_sdvar_sel_clean_all_B <- filter(training_sdvar_sel_clean_all, classe == "B")
training_sdvar_sel_clean_all_C <- filter(training_sdvar_sel_clean_all, classe == "C")
training_sdvar_sel_clean_all_D <- filter(training_sdvar_sel_clean_all, classe == "D")
training_sdvar_sel_clean_all_E <- filter(training_sdvar_sel_clean_all, classe == "E")


f <- list(family = "Courier New, monospace",size = 18,color = "#7f7f7f")

x <- list(title = "Avg Roll of the Dumbell (degrees)",titlefont = f)
y <- list(title = "Std Dev of the Belt Roll (degrees)",titlefont = f)
p <- plot_ly(x = training_sdvar_sel_clean_all_A$avg_roll_dumbbell, 
             y = training_sdvar_sel_clean_all_A$stddev_roll_belt, 
             mode = "markers") %>%
              layout(xaxis = x, yaxis = y) %>%
              layout(title="Low Correlation Example A sequence")
p

x <- list(title = "Avg Yaw of the Belt (degrees)",titlefont = f)
y <- list(title = "Min Pitch of the Dumbbell (degrees)",titlefont = f)
p <- plot_ly(x = training_sdvar_sel_clean_all_A$avg_yaw_belt, 
             y = training_sdvar_sel_clean_all_A$min_pitch_dumbbell, 
             mode = "markers") %>%
              layout(xaxis = x, yaxis = y) %>%
              layout(title="High Correlation Example A sequence")
p

x <- list(title = "Avg Roll of the Dumbell (degrees)",titlefont = f)
y <- list(title = "Std Dev of the Belt Roll (degrees)",titlefont = f)
p <- plot_ly(x = training_sdvar_sel_clean_all_C$avg_roll_dumbbell, 
             y = training_sdvar_sel_clean_all_C$stddev_roll_belt, 
             mode = "markers") %>%
  layout(xaxis = x, yaxis = y) %>%
  layout(title="Low Correlation Example C sequence")
p

x <- list(title = "Avg Yaw of the Belt (degrees)",titlefont = f)
y <- list(title = "Min Pitch of the Dumbbell (degrees)",titlefont = f)
p <- plot_ly(x = training_sdvar_sel_clean_all_C$avg_yaw_belt, 
             y = training_sdvar_sel_clean_all_C$min_pitch_dumbbell, 
             mode = "markers") %>%
  layout(xaxis = x, yaxis = y) %>%
  layout(title="High Correlation Example C sequence")
p


x <- list(title = "Avg Roll of the Dumbell (degrees)",titlefont = f)
y <- list(title = "Std Dev of the Belt Roll (degrees)",titlefont = f)
p <- plot_ly(x = training_sdvar_sel_clean_all_E$avg_roll_dumbbell, 
             y = training_sdvar_sel_clean_all_E$stddev_roll_belt, 
             mode = "markers") %>%
  layout(xaxis = x, yaxis = y) %>%
  layout(title="Low Correlation Example E sequence")
p

x <- list(title = "Avg Yaw of the Belt (degrees)",titlefont = f)
y <- list(title = "Min Pitch of the Dumbbell (degrees)",titlefont = f)
p <- plot_ly(x = training_sdvar_sel_clean_all_E$avg_yaw_belt, 
             y = training_sdvar_sel_clean_all_E$min_pitch_dumbbell, 
             mode = "markers") %>%
  layout(xaxis = x, yaxis = y) %>%
  layout(title="High Correlation Example E sequence")
p

```
